

<div class="booking-details-container">
  <div class="page-header">
    <h1>üí≥ Event Booking & Payment Portal</h1>
    <p class="subtitle">Search for events and complete your booking</p>
  </div>

  <!-- Search Form -->
  <div class="search-section">
    <form [formGroup]="itemForm" (ngSubmit)="searchEvent()" class="search-form">
      <div class="form-group">
        <label for="searchTerm">Search Event</label>
        <div class="input-group">
          <input 
            type="text" 
            id="searchTerm"
            formControlName="searchTerm" 
            class="form-control"
            placeholder="Enter event ID or title"
            [class.is-invalid]="itemForm.get('searchTerm')?.invalid && itemForm.get('searchTerm')?.touched"
          />
          <button type="submit" class="btn btn-primary" [disabled]="!itemForm.valid">
            <span class="search-icon">üîç</span>
            Search
          </button>
        </div>
        <div class="error-message" *ngIf="itemForm.get('searchTerm')?.invalid && itemForm.get('searchTerm')?.touched">
          Search term is required
        </div>
      </div>
    </form>
  </div>

  <!-- Status Message -->
  <div *ngIf="message" class="alert" [ngClass]="message.type === 'success' ? 'alert-success' : 'alert-error'">
    <span class="alert-icon">{{ message.type === 'success' ? '‚úì' : '‚úï' }}</span>
    {{ message.text }}
  </div>

  <!-- No Results Message -->
  <div *ngIf="searchPerformed && eventObj.length === 0 && !message" class="no-results">
    <div class="no-results-icon">üì≠</div>
    <h3>No Events Found</h3>
    <p>No events found matching your search criteria</p>
  </div>

  <!-- Results Section -->
  <div *ngIf="searchPerformed && eventObj.length > 0" class="results-section">
    <div class="event-card" *ngFor="let ev of eventObj">
      <!-- Event Header -->
      <div class="event-header">
        <h2 class="event-title">{{ ev.title }}</h2>
        <span class="badge" [ngClass]="getStatusClass(ev.status)">
          {{ ev.status | titlecase }}
        </span>
        <!-- Paid chip -->
        <span *ngIf="ev.paymentCompleted" class="badge badge-success" style="margin-left: 8px;">
          ‚úÖ Paid
        </span>
      </div>

      <!-- Event Details -->
      <div class="event-details">
        <div class="detail-item">
          <span class="detail-icon">üÜî</span>
          <span class="detail-label">Event ID:</span>
          <span class="detail-value">{{ ev.eventID }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üìù</span>
          <span class="detail-label">Description:</span>
          <span class="detail-value">{{ ev.description }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üìÖ</span>
          <span class="detail-label">Date & Time:</span>
          <span class="detail-value">{{ ev.dateTime | date:'medium' }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üìç</span>
          <span class="detail-label">Location:</span>
          <span class="detail-value">{{ ev.location }}</span>
        </div>
      </div>

      <!-- Allocations Table -->
      <div class="allocations-section" *ngIf="ev.allocations && ev.allocations.length > 0">
        <h3 class="section-title">üì¶ Resources Allocated</h3>
        <div class="table-responsive">
          <table class="allocations-table">
            <thead>
              <tr>
                <th>Resource Name</th>
                <th>Type</th>
                <th>Unit Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of ev.allocations">
                <td>{{ allocation.resource.name }}</td>
                <td>{{ allocation.resource.type }}</td>
                <td class="price-cell">‚Çπ{{ allocation.resource.price | number:'1.2-2' }}</td>
                <td class="quantity-cell">{{ allocation.quantity }}</td>
                <td class="subtotal-cell">‚Çπ{{ calculateAllocationPrice(allocation) | number:'1.2-2' }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="4"><strong>Total Amount</strong></td>
                <td class="total-amount"><strong>‚Çπ{{ calculateTotalPrice(ev.allocations) | number:'1.2-2' }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- No Allocations Message -->
      <div class="no-allocations" *ngIf="!ev.allocations || ev.allocations.length === 0">
        <p>No resources allocated for this event</p>
      </div>

      <!-- Payment Action -->
      <div class="payment-action" *ngIf="ev.allocations && ev.allocations.length > 0">
        <!-- Show Pay button if not paid -->
        <button class="btn btn-pay"
                *ngIf="!ev.paymentCompleted"
                (click)="openPaymentModal(ev)">
          <span class="btn-icon">üí∞</span>
          <span class="btn-text">Proceed to Payment - ‚Çπ{{ calculateTotalPrice(ev.allocations) | number:'1.2-2' }}</span>
        </button>

        <!-- Show Paid chip if already paid -->
        <div *ngIf="ev.paymentCompleted"
             class="btn"
             style="background-color: #22c55e; color: #fff; cursor: default;">
          <span class="btn-icon">‚úÖ</span>
          <span class="btn-text">Paid</span>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 1: Payment Modal - Customer Details -->
  <div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
    <div class="modal-content payment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üí≥ Enter Payment Details</h2>
        <button class="modal-close" (click)="closePaymentModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="step-indicator">
          <div class="step active">
            <span class="step-number">1</span>
            <span class="step-label">Customer Details</span>
          </div>
          <div class="step">
            <span class="step-number">2</span>
            <span class="step-label">UPI Payment</span>
          </div>
        </div>

        <form [formGroup]="paymentForm">
          <div class="form-group">
            <label>Customer Name <span class="required">*</span></label>
            <input type="text" formControlName="customerName" placeholder="Enter your full name" class="form-input"
                   [class.error-input]="paymentForm.get('customerName')?.invalid && paymentForm.get('customerName')?.touched">
            <div class="error-text" *ngIf="paymentForm.get('customerName')?.invalid && paymentForm.get('customerName')?.touched">
              Name is required
            </div>
          </div>

          <div class="form-group">
            <label>Email <span class="required">*</span></label>
            <input type="email" formControlName="customerEmail" placeholder="your.email@example.com" class="form-input"
                   [class.error-input]="paymentForm.get('customerEmail')?.invalid && paymentForm.get('customerEmail')?.touched">
            <div class="error-text" *ngIf="paymentForm.get('customerEmail')?.invalid && paymentForm.get('customerEmail')?.touched">
              Valid email is required
            </div>
          </div>

          <div class="form-group">
            <label>Phone Number <span class="required">*</span></label>
            <input type="tel" formControlName="customerPhone" placeholder="10-digit phone number" class="form-input"
                   [class.error-input]="paymentForm.get('customerPhone')?.invalid && paymentForm.get('customerPhone')?.touched">
            <div class="error-text" *ngIf="paymentForm.get('customerPhone')?.invalid && paymentForm.get('customerPhone')?.touched">
              Valid 10-digit phone number required
            </div>
          </div>

          <div class="payment-summary">
            <div class="summary-row">
              <span>Event:</span>
              <span class="value">{{ selectedEvent?.title }}</span>
            </div>
            <div class="summary-row total">
              <span>Total Amount:</span>
              <span class="amount">‚Çπ{{ calculateTotalPrice(selectedEvent?.allocations) | number:'1.2-2' }}</span>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closePaymentModal()">Cancel</button>
        <button class="btn btn-primary btn-next" (click)="proceedToUpi()" [disabled]="isProcessing">
          <span *ngIf="!isProcessing">Continue to UPI Payment ‚Üí</span>
          <span *ngIf="isProcessing">Processing...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- STEP 2: UPI Payment Modal -->
  <div class="modal-overlay" *ngIf="showUpiModal" (click)="closeUpiModal()">
    <div class="modal-content upi-modal" (click)="$event.stopPropagation()">
      <div class="modal-header upi-header">
        <h2>üì± UPI Payment</h2>
        <button class="modal-close" (click)="closeUpiModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="step-indicator">
          <div class="step completed">
            <span class="step-number">‚úì</span>
            <span class="step-label">Customer Details</span>
          </div>
          <div class="step active">
            <span class="step-number">2</span>
            <span class="step-label">UPI Payment</span>
          </div>
        </div>

        <div class="upi-info">
          <div class="upi-icon">üì≤</div>
          <h3>Pay using UPI</h3>
          <p class="upi-description">Enter your UPI ID to complete the payment</p>

          <div class="amount-display">
            <div class="amount-label">Amount to Pay</div>
            <div class="amount-value">‚Çπ{{ calculateTotalPrice(selectedEvent?.allocations) | number:'1.2-2' }}</div>
          </div>

          <form [formGroup]="paymentForm">
            <div class="form-group">
              <label>UPI ID <span class="required">*</span></label>
              <input
                type="text"
                formControlName="upiId"
                placeholder="yourname@paytm"
                class="form-input upi-input"
                [class.error-input]="paymentForm.get('upiId')?.invalid && paymentForm.get('upiId')?.touched">
              <div class="error-text" *ngIf="paymentForm.get('upiId')?.invalid && paymentForm.get('upiId')?.touched">
                Valid UPI ID required (e.g., user@paytm)
              </div>
              <div class="input-hint">
                Format: username@provider (e.g., john@paytm, user@phonepe)
              </div>
            </div>
          </form>

          <div class="upi-examples">
            <p class="examples-label">Supported UPI Apps:</p>
            <div class="upi-apps">
              <span class="upi-app"><span class="app-icon">üì±</span>Google Pay</span>
              <span class="upi-app"><span class="app-icon">üì±</span>PhonePe</span>
              <span class="upi-app"><span class="app-icon">üì±</span>Paytm</span>
              <span class="upi-app"><span class="app-icon">üì±</span>BHIM</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeUpiModal()">‚Üê Back</button>
        <button class="btn btn-success btn-pay-now" (click)="processUpiPayment()" [disabled]="isProcessing">
          <span *ngIf="!isProcessing">
            <span class="pay-icon">üí∞</span>
            Pay ‚Çπ{{ calculateTotalPrice(selectedEvent?.allocations) | number:'1.2-2' }}
          </span>
          <span *ngIf="isProcessing">
            <span class="spinner">‚è≥</span>
            Processing Payment...
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Bill Summary Modal -->
  <div class="modal-overlay" *ngIf="showBillSummary">
    <div class="modal-content bill-modal" (click)="$event.stopPropagation()">
      <div class="modal-header success-header">
        <div class="success-animation">
          <div class="checkmark">‚úì</div>
        </div>
        <h2>Payment Successful!</h2>
        <p class="success-subtitle">Your payment has been processed successfully</p>
        <button class="modal-close" (click)="closeBillSummary()">‚úï</button>
      </div>

      <div class="modal-body bill-body">
        <!-- Transaction Details -->
        <div class="transaction-details">
          <h3>üìÑ Transaction Details</h3>
          <div class="detail-item">
            <span class="label">Transaction ID:</span>
            <span class="value transaction-id">{{ transactionDetails?.transactionId }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Date & Time:</span>
            <span class="value">{{ transactionDetails?.paymentDate | date: 'medium' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Payment Method:</span>
            <span class="value">UPI ({{ transactionDetails?.upiId }})</span>
          </div>
          <div class="detail-item">
            <span class="label">Status:</span>
            <span class="value status-success">‚úÖ PAID</span>
          </div>
        </div>

        <!-- Customer Details -->
        <div class="customer-details">
          <h3>üë§ Customer Information</h3>
          <div class="detail-item">
            <span class="label">Name:</span>
            <span class="value">{{ transactionDetails?.customerName }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Email:</span>
            <span class="value">{{ transactionDetails?.customerEmail }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Phone:</span>
            <span class="value">{{ transactionDetails?.customerPhone }}</span>
          </div>
        </div>

        <!-- Event Details -->
        <div class="bill-event-details">
          <h3>üìÖ Event Information</h3>
          <div class="detail-item">
            <span class="label">Event Name:</span>
            <span class="value">{{ selectedEvent?.title }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Location:</span>
            <span class="value">{{ selectedEvent?.location }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Date:</span>
            <span class="value">{{ selectedEvent?.dateTime | date: 'medium' }}</span>
          </div>
        </div>

        <!-- Items Summary -->
        <div class="items-summary">
          <h3>üì¶ Items</h3>
          <table class="bill-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of selectedEvent?.allocations">
                <td>{{ allocation.resource.name }}</td>
                <td>{{ allocation.quantity }}</td>
                <td>‚Çπ{{ allocation.resource.price | number:'1.2-2' }}</td>
                <td>‚Çπ{{ calculateAllocationPrice(allocation) | number:'1.2-2' }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="3"><strong>Total Paid</strong></td>
                <td><strong>‚Çπ{{ calculateTotalPrice(selectedEvent?.allocations) | number:'1.2-2' }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="bill-footer-note">
          <p>‚úÖ Thank you for your payment! A confirmation email has been sent to <strong>{{ transactionDetails?.customerEmail }}</strong></p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="downloadBill()">
          <span class="btn-icon">üì•</span>
          Download Receipt
        </button>
        <button class="btn btn-primary" (click)="shareBill()">
          <span class="btn-icon">üì§</span>
          Share Receipt
        </button>
        <button class="btn btn-success" (click)="closeBillSummary()">
          <span class="btn-icon">‚úì</span>
          Done
        </button>
      </div>
    </div>
  </div>
</div>
